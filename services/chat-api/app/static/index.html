<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF RAG Chatbot</title>
<!--
  Web Chat UI for the PDF RAG Chatbot.

  This is a single-file chat interface (no build step, no framework) served
  directly by the FastAPI Chat API at the root URL (/). It communicates with
  the same server's POST /chat endpoint, so there are no CORS issues.

  ARCHITECTURE:
  - Conversation history is managed client-side in a JS array and sent with
    every request, mirroring the OpenAI chat message format.
  - Source citations are displayed as expandable cards below each bot response.
  - The UI is responsive and works on mobile devices.

  This file is copied into the Docker image automatically because the Dockerfile
  already does `COPY app/ ./app/`, which includes `app/static/`.
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* =====================================================================
     CSS VARIABLES
     A warm, document-inspired palette. The chatbot is about PDFs, so the
     aesthetic evokes interacting with a living document: warm paper tones,
     editorial typography, footnote-style source citations.
     ===================================================================== */
  :root {
    --bg: #1a1917;
    --bg-surface: #23221f;
    --bg-elevated: #2c2b27;
    --bg-hover: #35342f;
    --text-primary: #e8e4dc;
    --text-secondary: #a8a49a;
    --text-dim: #706c63;
    --accent: #d4a574;
    --accent-dim: #a67c52;
    --accent-glow: rgba(212, 165, 116, 0.08);
    --user-bg: #2e3a2e;
    --user-border: #4a6b4a;
    --border: #35332e;
    --border-light: #2c2a26;
    --score-high: #7ab87a;
    --score-mid: #d4a574;
    --score-low: #c47a7a;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 2px 12px rgba(0,0,0,0.3);
    --font-display: 'DM Serif Display', Georgia, serif;
    --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
    --font-mono: 'IBM Plex Mono', 'Menlo', monospace;
  }

  /* =====================================================================
     RESET & BASE
     ===================================================================== */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 15px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* =====================================================================
     LAYOUT -- Full-height flex column
     ===================================================================== */
  .app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh; /* dynamic viewport height for mobile browsers */
    max-width: 820px;
    margin: 0 auto;
  }

  /* =====================================================================
     HEADER
     ===================================================================== */
  .header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--bg);
    font-weight: 600;
  }

  .header h1 {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 400;
    letter-spacing: -0.01em;
    color: var(--text-primary);
  }

  .header-subtitle {
    font-size: 12px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    letter-spacing: 0.02em;
  }

  .btn-clear {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 500;
    padding: 7px 14px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-clear:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
    border-color: var(--text-dim);
  }

  /* =====================================================================
     MESSAGES AREA
     ===================================================================== */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }

  /* Scrollbar styling */
  .messages::-webkit-scrollbar { width: 6px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  /* --- Welcome state --- */
  .welcome {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 16px;
    padding: 40px 20px;
    animation: fadeIn 0.6s ease;
  }

  .welcome-icon {
    width: 56px;
    height: 56px;
    background: var(--accent-glow);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
  }

  .welcome h2 {
    font-family: var(--font-display);
    font-size: 26px;
    font-weight: 400;
    color: var(--text-primary);
  }

  .welcome p {
    color: var(--text-secondary);
    max-width: 400px;
    font-size: 14px;
    line-height: 1.7;
  }

  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 8px;
  }

  .suggestion {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: var(--font-body);
    font-size: 13px;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .suggestion:hover {
    background: var(--bg-elevated);
    border-color: var(--accent-dim);
    color: var(--accent);
  }

  /* --- Message bubbles --- */
  .message {
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
  }

  .message-user { align-items: flex-end; }
  .message-bot { align-items: flex-start; }

  .message-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 6px;
    font-family: var(--font-mono);
  }

  .message-user .message-label { color: var(--user-border); }
  .message-bot .message-label { color: var(--accent-dim); }

  .message-bubble {
    max-width: 85%;
    padding: 14px 18px;
    border-radius: var(--radius);
    line-height: 1.65;
    font-size: 14.5px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .message-user .message-bubble {
    background: var(--user-bg);
    border: 1px solid var(--user-border);
    color: var(--text-primary);
    border-bottom-right-radius: 4px;
  }

  .message-bot .message-bubble {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
  }

  /* --- Source citations (styled as document footnotes) --- */
  .sources {
    max-width: 85%;
    margin-top: 10px;
  }

  .sources-toggle {
    background: none;
    border: none;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 0;
    transition: color 0.2s;
  }

  .sources-toggle:hover { color: var(--accent); }

  .sources-toggle .arrow {
    display: inline-block;
    transition: transform 0.2s;
    font-size: 10px;
  }

  .sources-toggle.open .arrow { transform: rotate(90deg); }

  .sources-list {
    display: none;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .sources-list.hidden { display: none; }

  .source-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 13px;
    transition: border-color 0.2s;
  }

  .source-card:hover { border-color: var(--accent-dim); }

  .source-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    font-family: var(--font-mono);
    font-size: 11px;
  }

  .source-page {
    color: var(--accent);
    font-weight: 500;
  }

  .source-file { color: var(--text-dim); }

  .source-score {
    margin-left: auto;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
  }

  .score-high { background: rgba(122,184,122,0.12); color: var(--score-high); }
  .score-mid { background: rgba(212,165,116,0.12); color: var(--score-mid); }
  .score-low { background: rgba(196,122,122,0.12); color: var(--score-low); }

  .source-text {
    color: var(--text-secondary);
    font-size: 12.5px;
    line-height: 1.55;
    /* Clamp to 3 lines with ellipsis */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* --- Loading indicator --- */
  .loading-dots {
    display: flex;
    gap: 5px;
    padding: 8px 0;
  }

  .loading-dots span {
    width: 7px;
    height: 7px;
    background: var(--accent-dim);
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }

  .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
  .loading-dots span:nth-child(3) { animation-delay: 0.3s; }

  /* =====================================================================
     INPUT AREA
     ===================================================================== */
  .input-area {
    padding: 16px 24px 20px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 6px 6px 18px;
    transition: border-color 0.2s;
  }

  .input-row:focus-within { border-color: var(--accent-dim); }

  .input-row textarea {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 14.5px;
    line-height: 1.5;
    resize: none;
    padding: 8px 0;
    max-height: 120px;
  }

  .input-row textarea::placeholder { color: var(--text-dim); }

  .btn-send {
    width: 40px;
    height: 40px;
    background: var(--accent);
    border: none;
    border-radius: var(--radius-sm);
    color: var(--bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .btn-send:hover { background: var(--accent-dim); }
  .btn-send:disabled { opacity: 0.3; cursor: not-allowed; }

  .btn-send svg { width: 18px; height: 18px; }

  .input-hint {
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    text-align: center;
  }

  /* =====================================================================
     ANIMATIONS
     ===================================================================== */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* =====================================================================
     RESPONSIVE
     ===================================================================== */
  @media (max-width: 600px) {
    .header { padding: 14px 16px 12px; }
    .header h1 { font-size: 18px; }
    .messages { padding: 16px; gap: 16px; }
    .message-bubble { max-width: 92%; font-size: 14px; }
    .sources { max-width: 92%; }
    .input-area { padding: 12px 16px 16px; }
    .suggestions { flex-direction: column; align-items: center; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- ================================================================= -->
  <!-- HEADER                                                            -->
  <!-- ================================================================= -->
  <header class="header">
    <div class="header-left">
      <div class="logo">R</div>
      <div>
        <h1>PDF RAG Chatbot</h1>
        <div class="header-subtitle">retrieval-augmented generation</div>
      </div>
    </div>
    <button class="btn-clear" onclick="clearConversation()" title="Clear conversation history">
      Clear
    </button>
  </header>

  <!-- ================================================================= -->
  <!-- MESSAGES                                                          -->
  <!-- ================================================================= -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">&#128218;</div>
      <h2>Ask about your documents</h2>
      <p>
        This chatbot uses Retrieval-Augmented Generation to answer questions
        grounded in your PDF documents, with source citations.
      </p>
      <div class="suggestions">
        <button class="suggestion" onclick="askSuggestion(this)">What is this book about?</button>
        <button class="suggestion" onclick="askSuggestion(this)">Summarize the key concepts</button>
        <button class="suggestion" onclick="askSuggestion(this)">What topics are covered?</button>
      </div>
    </div>
  </div>

  <!-- ================================================================= -->
  <!-- INPUT                                                             -->
  <!-- ================================================================= -->
  <div class="input-area">
    <div class="input-row">
      <textarea
        id="input"
        rows="1"
        placeholder="Ask a question about your PDF..."
        onkeydown="handleKeyDown(event)"
        oninput="autoResize(this)"
      ></textarea>
      <button class="btn-send" id="sendBtn" onclick="sendMessage()" title="Send message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
    <div class="input-hint">Enter to send &middot; Shift+Enter for new line</div>
  </div>
</div>

<script>
// =========================================================================
// STATE
// =========================================================================
// Conversation history in OpenAI chat message format. Sent with every
// request so the LLM has context for follow-up questions.
// =========================================================================
let history = [];
let isLoading = false;

const messagesEl = document.getElementById("messages");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const welcomeEl = document.getElementById("welcome");

// =========================================================================
// SEND MESSAGE
// =========================================================================
async function sendMessage() {
  const question = inputEl.value.trim();
  if (!question || isLoading) return;

  // Hide the welcome screen on first message.
  if (welcomeEl) welcomeEl.remove();

  // Render the user's message bubble.
  appendMessage("user", question);

  // Clear input and reset height.
  inputEl.value = "";
  inputEl.style.height = "auto";
  setLoading(true);

  // Show a loading indicator while waiting for the API.
  const loadingEl = appendLoading();

  try {
    // ---------------------------------------------------------------
    // POST /chat -- the same endpoint the CLI client uses.
    // We send the full conversation history so the LLM can understand
    // follow-up questions (e.g., "tell me more about that").
    // ---------------------------------------------------------------
    const resp = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        question: question,
        history: history.length ? history : null,
      }),
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ detail: resp.statusText }));
      throw new Error(err.detail || `HTTP ${resp.status}`);
    }

    const data = await resp.json();

    // Remove loading indicator and render the bot's response.
    loadingEl.remove();
    appendMessage("bot", data.answer, data.sources);

    // Update conversation history for multi-turn context.
    history.push({ role: "user", content: question });
    history.push({ role: "assistant", content: data.answer });

  } catch (err) {
    loadingEl.remove();
    appendMessage("bot", `Error: ${err.message}. Make sure the API is running.`);
  } finally {
    setLoading(false);
  }
}

// =========================================================================
// UI HELPERS
// =========================================================================

function appendMessage(role, text, sources) {
  const wrapper = document.createElement("div");
  wrapper.className = `message message-${role}`;

  const label = document.createElement("div");
  label.className = "message-label";
  label.textContent = role === "user" ? "You" : "Assistant";

  const bubble = document.createElement("div");
  bubble.className = "message-bubble";
  bubble.textContent = text;

  wrapper.appendChild(label);
  wrapper.appendChild(bubble);

  // Render source citations as expandable footnote cards.
  if (sources && sources.length > 0) {
    wrapper.appendChild(buildSourcesWidget(sources));
  }

  messagesEl.appendChild(wrapper);
  scrollToBottom();
}

function buildSourcesWidget(sources) {
  const container = document.createElement("div");
  container.className = "sources";

  // Toggle button
  const toggle = document.createElement("button");
  toggle.className = "sources-toggle";
  toggle.innerHTML = `<span class="arrow">&#9654;</span> ${sources.length} source${sources.length > 1 ? "s" : ""} cited`;
  container.appendChild(toggle);

  // Source cards list (hidden by default)
  const list = document.createElement("div");
  list.className = "sources-list hidden";

  for (const src of sources) {
    const card = document.createElement("div");
    card.className = "source-card";

    // Determine score color class based on similarity score.
    // 0.7+ = high (green), 0.5-0.7 = mid (amber), <0.5 = low (red)
    const score = src.score || 0;
    const scoreClass = score >= 0.7 ? "score-high" : score >= 0.5 ? "score-mid" : "score-low";

    card.innerHTML = `
      <div class="source-meta">
        <span class="source-page">Page ${src.page_number}</span>
        <span class="source-file">${src.source || "unknown"}</span>
        <span class="source-score ${scoreClass}">${(score * 100).toFixed(0)}% match</span>
      </div>
      <div class="source-text">${escapeHtml(src.text || "")}</div>
    `;
    list.appendChild(card);
  }

  container.appendChild(list);

  // Toggle visibility on click.
  toggle.addEventListener("click", () => {
    toggle.classList.toggle("open");
    list.classList.toggle("hidden");
  });

  return container;
}

function appendLoading() {
  const wrapper = document.createElement("div");
  wrapper.className = "message message-bot";

  const label = document.createElement("div");
  label.className = "message-label";
  label.textContent = "Assistant";

  const dots = document.createElement("div");
  dots.className = "loading-dots";
  dots.innerHTML = "<span></span><span></span><span></span>";

  wrapper.appendChild(label);
  wrapper.appendChild(dots);
  messagesEl.appendChild(wrapper);
  scrollToBottom();
  return wrapper;
}

function setLoading(loading) {
  isLoading = loading;
  sendBtn.disabled = loading;
  inputEl.disabled = loading;
  if (!loading) inputEl.focus();
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function clearConversation() {
  history = [];
  // Remove all messages but re-add the welcome screen.
  messagesEl.innerHTML = `
    <div class="welcome" id="welcome">
      <div class="welcome-icon">&#128218;</div>
      <h2>Ask about your documents</h2>
      <p>
        This chatbot uses Retrieval-Augmented Generation to answer questions
        grounded in your PDF documents, with source citations.
      </p>
      <div class="suggestions">
        <button class="suggestion" onclick="askSuggestion(this)">What is this book about?</button>
        <button class="suggestion" onclick="askSuggestion(this)">Summarize the key concepts</button>
        <button class="suggestion" onclick="askSuggestion(this)">What topics are covered?</button>
      </div>
    </div>
  `;
}

function askSuggestion(el) {
  inputEl.value = el.textContent;
  sendMessage();
}

function handleKeyDown(e) {
  // Enter sends the message; Shift+Enter inserts a newline.
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 120) + "px";
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// Focus the input on page load.
inputEl.focus();
</script>

</body>
</html>
